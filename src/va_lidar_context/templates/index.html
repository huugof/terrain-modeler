<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Terrain Modeler</title>
        <link rel="icon" type="image/svg+xml" id="favicon" href="data:," />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='app.css') }}"
        />
    </head>
    <body>
        <div id="topBar" class="top-bar">
            <button
                type="button"
                id="wireframeToggle"
                class="theme-toggle wireframe-toggle"
                aria-label="Toggle wireframe preview"
                title="Toggle wireframe preview"
                aria-pressed="false"
                disabled
            >
                <i data-lucide="box"></i>
            </button>
            <button
                type="button"
                id="buildingsToggle"
                class="theme-toggle buildings-toggle"
                aria-label="Toggle buildings in preview"
                title="Toggle buildings in preview"
                aria-pressed="false"
                disabled
            >
                <i data-lucide="house"></i>
            </button>
            {% if auth_enabled and current_user %}
            {% set top_profile_display = current_user.get('name') or current_user.email %}
            <div id="topProfileShell" class="profile-shell">
                <button
                    type="button"
                    id="topProfileButton"
                    class="theme-toggle top-profile-icon-btn"
                    aria-label="Profile menu"
                    aria-haspopup="menu"
                    aria-expanded="false"
                    aria-controls="topProfileDropdown"
                    title="{{ current_user.email }}"
                >
                    <i data-lucide="user" aria-hidden="true"></i>
                </button>
                <div id="topProfileDropdown" class="top-profile-dropdown hidden" role="menu">
                    <div class="top-profile-item top-profile-identity">
                        {{ top_profile_display }}
                    </div>
                    <a
                        href="#"
                        id="topRecentJobsLink"
                        class="top-profile-item"
                        role="menuitem"
                    >
                        Recent jobs
                    </a>
                    <button
                        class="top-profile-item"
                        type="submit"
                        form="logoutForm"
                        role="menuitem"
                    >
                        Sign out
                    </button>
                </div>
            </div>
            {% elif auth_enabled and not current_user %}
            <a class="top-login-btn" href="{{ url_for('bp.auth_login', next='/') }}" data-auth-open="1">Sign in</a>
            {% endif %}
        </div>
        <main>
            <div class="layout-split">
            <div class="layout-preview-col" id="inlinePreviewCol">
                <div class="inline-preview-panel" id="inlinePreviewPanel">
                    <div class="inline-preview-demo" id="inlinePreviewDemo" aria-hidden="true">
                        <svg class="inline-preview-demo-graphic" viewBox="0 0 400 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <defs>
                                <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="currentColor" stop-opacity="0.06"/>
                                    <stop offset="100%" stop-color="currentColor" stop-opacity="0.01"/>
                                </linearGradient>
                            </defs>
                            <rect width="400" height="260" fill="url(#sky)"/>
                            <polyline points="20,220 60,210 100,200 140,195 180,200 220,205 260,200 300,190 340,195 380,205" fill="none" stroke="currentColor" stroke-opacity="0.18" stroke-width="1.5"/>
                            <polyline points="20,200 60,185 100,170 140,160 180,165 220,175 260,165 300,150 340,158 380,175" fill="none" stroke="currentColor" stroke-opacity="0.22" stroke-width="1.5"/>
                            <polyline points="30,180 70,160 110,140 150,125 190,130 230,145 270,130 310,112 350,122 385,140" fill="none" stroke="currentColor" stroke-opacity="0.26" stroke-width="1.5"/>
                            <polyline points="50,162 90,138 130,115 170,96 210,100 250,118 290,100 325,82 360,95 390,112" fill="none" stroke="currentColor" stroke-opacity="0.30" stroke-width="1.5"/>
                            <polyline points="80,148 120,120 160,92 200,72 240,78 275,96 308,78 340,62 372,76 395,92" fill="none" stroke="currentColor" stroke-opacity="0.34" stroke-width="1.5"/>
                            <polyline points="120,138 158,106 196,76 230,55 265,62 295,80 325,62 355,46 382,60" fill="none" stroke="currentColor" stroke-opacity="0.28" stroke-width="1.5"/>
                        </svg>
                        <p class="inline-preview-demo-label">Build to preview terrain</p>
                    </div>
                    <iframe
                        id="inlinePreviewFrame"
                        class="inline-preview-frame"
                        title="Terrain preview"
                        src="about:blank"
                    ></iframe>
                    <div class="inline-preview-building" id="inlinePreviewBuilding" aria-hidden="true">
                        <div class="inline-preview-building-inner">
                            <svg class="inline-preview-building-spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                            </svg>
                            <span id="inlinePreviewBuildStatus">Building&hellip;</span>
                        </div>
                    </div>
                </div>
            </div><!-- /.layout-preview-col -->
            <div class="layout-form-col">
            <form
                class="card app-card"
                method="post"
                action="{{ url_for('bp.run_job') }}"
            >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="card-header">
                    <span class="card-logo">
                        <img
                            class="card-logo-mark"
                            src="{{ url_for('static', filename='logo-canyon-lowpoly.svg') }}"
                            alt=""
                            aria-hidden="true"
                        />
                        <span>Meshd</span>
                    </span>
                    <div class="card-header-actions">
                        <div id="menuShell" class="menu-shell">
                            <button
                                type="button"
                                id="menuButton"
                                class="menu-button"
                                aria-label="Recent jobs"
                                title="Recent jobs"
                                aria-haspopup="menu"
                                aria-expanded="false"
                                aria-controls="menuDropdown"
                            >
                                <i data-lucide="rotate-ccw"></i>
                            </button>
                            <div id="menuDropdown" class="menu-dropdown hidden" role="menu">
                                <div class="menu-section-title">Recent Jobs</div>
                                <div id="recentJobs" class="recent-jobs-scroll">
                                    {% if recent_jobs %}
                                    <ul class="recent-job-list">
                                        {% for job in recent_jobs %}
                                        <li class="recent-job-row">
                                            <div class="recent-job-meta">
                                                <div class="recent-job-title">{{ job.name }}</div>
                                                {% if job.status in ['queued', 'running'] and job.stage_label %}
                                                <div class="recent-job-stage">{{ job.stage_label }}{% if job.stage_progress is not none %} ({{ job.stage_progress }}%){% endif %}</div>
                                                {% endif %}
                                            </div>
                                            {% if job.status in ['done', 'error'] %}
                                            <div class="recent-job-actions">
                                                {% if job.preview_url %}
                                                <a
                                                    class="recent-job-pill"
                                                    href="{{ job.preview_url }}"
                                                    data-preview-inline="1"
                                                    data-preview-url="{{ job.preview_url }}"
                                                    data-form-defaults="{{ job.form_defaults | tojson | forceescape }}"
                                                >Preview</a>
                                                {% endif %}
                                                {% if job.download_all_url %}
                                                <a class="recent-job-pill" href="{{ job.download_all_url }}" aria-label="Download job files" title="Download job files"><i data-lucide="download"></i></a>
                                                {% endif %}
                                                {% if job.delete_url %}
                                                <button
                                                    type="button"
                                                    class="recent-job-pill recent-job-pill-delete"
                                                    data-job-delete-url="{{ job.delete_url }}"
                                                    data-job-id="{{ job.job_id }}"
                                                    aria-label="Delete job"
                                                    title="Delete job"
                                                ><i data-lucide="trash-2"></i></button>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p class="footer">No jobs yet.</p>
                                    {% endif %}
                                </div>
                                {% if auth_enabled and current_user %}
                                <div class="menu-divider"></div>
                                {% if current_user.is_admin %}
                                <a class="menu-link" href="{{ url_for('bp.admin_users') }}">Admin</a>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-header-divider"></div>
                <div class="form-body">
                    <div>
                        <label>Coordinates</label>
                        <input
                            type="text"
                            name="coords"
                            value="{{ defaults.center1 }}, {{ defaults.center2 }}"
                            placeholder="lat, lon"
                        />
                    </div>
                    <input type="hidden" name="job_name" value="{{ defaults.job_name }}" />
                    <div class="grid two-col">
                        <div>
                            <label>Map Size</label>
                            <input
                                id="mapSizeInput"
                                type="number"
                                step="any"
                                name="size"
                                value="{{ defaults.clip_size }}"
                            />
                        </div>
                        <div>
                            <label>Units</label>
                            <select name="units">
                                <option value="feet" {% if defaults.units is equalto 'feet' %}selected{% endif %}>feet</option>
                                <option value="meters" {% if defaults.units is equalto 'meters' %}selected{% endif %}>meters</option>
                            </select>
                        </div>
                    </div>

                    <div class="outputs-block">
                        <label class="outputs-label">Outputs</label>
                        <div class="output-toggle-grid">
                            <button type="button" class="output-toggle-btn {% if defaults.output_contours %}active{% endif %}" data-input="output_contours" title="contours.dxf">Contours</button>
                            <button type="button" class="output-toggle-btn {% if defaults.output_xyz %}active{% endif %}" data-input="output_xyz" title="terrain.xyz">Point Cloud</button>
                            <button type="button" class="output-toggle-btn {% if defaults.output_naip %}active{% endif %}" data-input="output_naip" title="terrain.png">Satellite Image</button>
                            <button type="button" class="output-toggle-btn {% if defaults.output_terrain %}active{% endif %}" data-input="output_terrain" title="terrain.obj">Mesh</button>
                            <button type="button" class="output-toggle-btn {% if defaults.output_buildings %}active{% endif %}" data-input="output_buildings" title="buildings.obj">Buildings</button>
                        </div>
                        <input type="checkbox" id="output_contours" name="output_contours" class="visually-hidden" {% if defaults.output_contours %}checked{% endif %} />
                        <input type="checkbox" id="output_xyz" name="output_xyz" class="visually-hidden" {% if defaults.output_xyz %}checked{% endif %} />
                        <input type="checkbox" id="output_naip" name="output_naip" class="visually-hidden" {% if defaults.output_naip %}checked{% endif %} />
                        <input type="checkbox" id="output_terrain" name="output_terrain" class="visually-hidden" {% if defaults.output_terrain %}checked{% endif %} />
                        <input type="checkbox" id="output_buildings" name="output_buildings" class="visually-hidden" {% if defaults.output_buildings %}checked{% endif %} />
                        <p class="inline-note">
                            Buildings are off by default. Enabling buildings increases build time, and inferred building heights can be inaccurate in some areas.
                        </p>
                    </div>

                    <div id="advancedControls" class="advanced-controls">
                        <div id="meshResolutionSection">
                            <label title="Controls terrain mesh detail in preview/export. Higher values preserve more detail but increase build time and output file size.">Output Resolution</label>
                            <div class="slider-row">
                                <input
                                    type="range"
                                    min="0"
                                    max="10"
                                    step="1"
                                    name="terrain_complexity"
                                    value="{{ defaults.terrain_complexity }}"
                                    oninput="
                                        document.getElementById(
                                            'complexityValue',
                                        ).textContent = this.value
                                    "
                                />
                                <div id="complexityValue">
                                    {{ defaults.terrain_complexity }}
                                </div>
                            </div>
                            <p class="inline-note">Higher values keep more terrain detail; lower values build faster and export smaller files.</p>
                        </div>

                        <div id="rotationSection">
                            <label
                                title="Degrees from true north (+Y). Positive is counter-clockwise, negative is clockwise. Rotates meshes and DXF/XYZ around the --center point. terrain.png stays north-up on disk, while texture mapping remains aligned to the rotated terrain mesh."
                                >North (degrees)</label
                            >
                            <input
                                id="northInput"
                                type="number"
                                step="any"
                                name="rotate_z"
                                value="{{ defaults.rotate_z }}"
                            />
                        </div>

                        <div id="contourSmoothingSection">
                            <label title="Smooths contour polylines after extraction by resampling line vertices. Higher values produce cleaner curves but can remove sharp local detail.">Contour Smoothing</label>
                            <div class="slider-row">
                                <input
                                    type="range"
                                    id="dxfSpacingRange"
                                    name="dxf_contour_spacing"
                                    min="0"
                                    max="10"
                                    step="1"
                                    value="{{ defaults.dxf_contour_spacing }}"
                                    oninput="
                                        document.getElementById(
                                            'dxfSpacingValue',
                                        ).textContent = this.value
                                    "
                                />
                                <div id="dxfSpacingValue">
                                    {{ defaults.dxf_contour_spacing }}
                                </div>
                            </div>
                            <p class="inline-note">Lower values preserve sharper contour detail. Higher values produce cleaner, simpler lines.</p>
                        </div>

                        <div class="grid two-col">
                            <div id="contourIntervalSection">
                                <label
                                    >Contour Interval</label
                                >
                                <div
                                    class="segmented"
                                    data-target="contour_interval"
                                >
                                    <button type="button" data-value="1">
                                        1
                                    </button>
                                    <button type="button" data-value="2">
                                        2
                                    </button>
                                    <button type="button" data-value="5">
                                        5
                                    </button>
                                    <button type="button" data-value="10">
                                        10
                                    </button>
                                </div>
                                <input
                                    type="hidden"
                                    id="contour_interval"
                                    name="contour_interval"
                                    value="{{ defaults.contour_interval }}"
                                />
                            </div>
                            <div id="contourLayersSection">
                                <label>Layers</label>
                                <div class="segmented contour-icons" data-toggle-group="layers">
                                    <button
                                        type="button"
                                        class="active static"
                                        title="Contours"
                                        aria-label="Contours"
                                        disabled
                                    >
                                        <i data-lucide="waves"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_parcels"
                                        title="Parcels"
                                        aria-label="Parcels"
                                    >
                                        <i data-lucide="layout-grid"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_buildings"
                                        title="Building Footprints"
                                        aria-label="Building Footprints"
                                    >
                                        <i data-lucide="house"></i>
                                    </button>
                                </div>
                                <input
                                    type="checkbox"
                                    id="dxf_include_parcels"
                                    name="dxf_include_parcels"
                                    class="visually-hidden"
                                    {%
                                    if
                                    defaults.dxf_include_parcels
                                    %}checked{%
                                    endif
                                    %}
                                />
                                <input
                                    type="checkbox"
                                    id="dxf_include_buildings"
                                    name="dxf_include_buildings"
                                    class="visually-hidden"
                                    {%
                                    if
                                    defaults.dxf_include_buildings
                                    %}checked{%
                                    endif
                                    %}
                                />
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="xyzSamplingSection">
                                <label>Point Cloud</label>
                                <select id="xyz_mode" name="xyz_mode">
                                    <option value="contours" {% if defaults.xyz_mode is equalto 'contours' %}selected{% endif %}>Contours</option>
                                    <option value="grid" {% if defaults.xyz_mode is equalto 'grid' %}selected{% endif %}>Uniform Grid</option>
                                </select>
                            </div>
                            <div id="imageQualitySection">
                                <label>Image Quality</label>
                                <div
                                    class="segmented"
                                    data-target="image_quality"
                                >
                                    <button type="button" data-value="standard">
                                        S
                                    </button>
                                    <button type="button" data-value="high">
                                        M
                                    </button>
                                    <button type="button" data-value="ultra">
                                        L
                                    </button>
                                </div>
                                <input
                                    type="hidden"
                                    id="image_quality"
                                    name="image_quality"
                                    value="{{ defaults.image_quality }}"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <div id="parcelAlert" class="status hidden"></div>
                    <div class="footer-divider"></div>
                    <button class="btn btn-full" id="runBtn" type="submit">
                        Build
                    </button>
                    <div class="form-byline">
                        &copy; 2026 Meshd &nbsp;&middot;&nbsp; <a class="byline-source-link" href="{{ url_for('bp.data_sources') }}">Data Sources</a>
                    </div>
                </div>
            </form>
            {% if auth_enabled and current_user %}
            <form
                id="logoutForm"
                method="post"
                action="{{ url_for('bp.auth_logout') }}"
                class="hidden"
            >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            </form>
            {% endif %}
            </div><!-- /.layout-form-col -->
            </div><!-- /.layout-split -->
        </main>
        <div id="previewModal" class="preview-modal hidden" aria-hidden="true">
            <div class="preview-modal-backdrop" data-preview-close="1"></div>
            <div class="preview-modal-dialog" role="dialog" aria-modal="true" aria-label="Job Preview">
                <iframe id="previewModalFrame" class="preview-modal-frame" title="Job Preview"></iframe>
            </div>
        </div>
        <i
            id="faviconSource"
            class="visually-hidden"
            data-lucide="mountain"
            aria-hidden="true"
        ></i>
        <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.min.js"
                integrity="sha384-GzE8qT1LzDfRNjtvLN/dXDLPlJOB3BBom3Twb9/RwHkXCgNl6OU1pBxM9397HWGU"
                crossorigin="anonymous"></script>
        <script>
          window.APP_CONFIG = {
            parcelSources: {{ parcel_sources | tojson }},
            canBuild: {{ can_build | tojson }},
            authEnabled: {{ auth_enabled | tojson }},
            authLoginUrl: {{ url_for('bp.auth_login') | tojson }},
            clerkPublishableKey: {{ clerk_publishable_key | tojson }},
            clerkFrontendApiUrl: {{ clerk_frontend_api_url | tojson }},
            initialPreviewUrl: {{ initial_preview_url | tojson }},
          };
        </script>
        <script src="{{ url_for('static', filename='app.js') }}" defer></script>
    </body>
</html>
