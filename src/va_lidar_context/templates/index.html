<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Terrain Modeler</title>
        <link rel="icon" type="image/svg+xml" id="favicon" href="data:," />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='app.css') }}"
        />
    </head>
    <body>
        {% if auth_enabled and current_user %}
        {% set profile_name = current_user.get('name') or ((current_user.get('email') or '').split('@')[0]) or 'User' %}
        {% set profile_initial = (profile_name[:1] if profile_name else 'U')|upper %}
        <div id="profileShell" class="profile-shell">
            <button
                type="button"
                id="profileButton"
                class="profile-button"
                aria-label="Account menu"
                aria-haspopup="menu"
                aria-expanded="false"
                aria-controls="profileDropdown"
            >
                {{ profile_initial }}
            </button>
            <div id="profileDropdown" class="profile-dropdown hidden" role="menu" aria-labelledby="profileButton">
                <p class="profile-row">
                    Signed in as <strong>{{ current_user.email }}</strong>
                </p>
                {% if current_user.is_admin %}
                <a class="profile-link" href="{{ url_for('admin_users') }}">Admin</a>
                {% endif %}
                <form method="post" action="{{ url_for('auth_logout') }}" class="profile-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button class="btn secondary profile-logout" type="submit">Sign out</button>
                </form>
            </div>
        </div>
        {% endif %}
        <header>
            <h1>Terrain Modeler</h1>
            <p class="sub">
                Generate site context and contour models for anywhere in the
                USA.
            </p>
        </header>
        <main>
            <form
                class="card app-card"
                method="post"
                action="{{ url_for('run_job') }}"
            >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="form-body">
                    <div class="section-title">Location</div>
                    <div class="grid">
                        <div style="grid-column: 1 / -1">
                            <label>Coordinates</label>
                            <input
                                type="text"
                                name="coords"
                                value="{{ defaults.center1 }}, {{ defaults.center2 }}"
                                placeholder="lat, lon"
                            />
                        </div>
                        <div>
                            <label>Map Size (Square)</label>
                            <input
                                type="number"
                                step="any"
                                name="size"
                                value="{{ defaults.clip_size }}"
                            />
                        </div>
                        <div>
                            <label>Units</label>
                            <select name="units">
                                <option value="feet" {% if defaults.units is equalto 'feet' %}selected{% endif %}>feet</option>
                                <option value="meters" {% if defaults.units is equalto 'meters' %}selected{% endif %}>meters</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title" style="margin-top: 16px">
                        Outputs
                    </div>
                    <div class="check-row">
                        <label class="check" title="contours.dxf (DXF)"
                            ><input
                                type="checkbox"
                                id="output_contours"
                                name="output_contours"
                                {%
                                if
                                defaults.output_contours
                                %}checked{%
                                endif
                                %}
                            />
                            Contours</label
                        >
                        <label class="check" title="terrain.xyz (XYZ)"
                            ><input
                                type="checkbox"
                                id="output_xyz"
                                name="output_xyz"
                                {%
                                if
                                defaults.output_xyz
                                %}checked{%
                                endif
                                %}
                            />
                            Point Cloud</label
                        >
                        <label class="check" title="terrain.png (PNG)"
                            ><input
                                type="checkbox"
                                id="output_naip"
                                name="output_naip"
                                {%
                                if
                                defaults.output_naip
                                %}checked{%
                                endif
                                %}
                            />
                            Satellite Image</label
                        >
                    </div>
                    <div class="check-row" style="margin-top: 6px">
                        <label class="check" title="terrain.obj (OBJ)"
                            ><input
                                type="checkbox"
                                id="output_terrain"
                                name="output_terrain"
                                {%
                                if
                                defaults.output_terrain
                                %}checked{%
                                endif
                                %}
                            />
                            Terrain Mesh</label
                        >
                        <label class="check" title="buildings.obj (OBJ)"
                            ><input
                                type="checkbox"
                                id="output_buildings"
                                name="output_buildings"
                                {%
                                if
                                defaults.output_buildings
                                %}checked{%
                                endif
                                %}
                            />
                            Building Massing</label
                        >
                    </div>

                    <div class="section-title" style="margin-top: 18px">
                        Settings
                    </div>
                    <div id="advancedControls" class="advanced-controls">
                        <div id="meshResolutionSection">
                            <label>Output Resolution</label>
                            <div class="slider-row">
                                <input
                                    type="range"
                                    min="0"
                                    max="10"
                                    step="1"
                                    name="terrain_complexity"
                                    value="{{ defaults.terrain_complexity }}"
                                    oninput="
                                        document.getElementById(
                                            'complexityValue',
                                        ).textContent = this.value
                                    "
                                />
                                <div id="complexityValue">
                                    {{ defaults.terrain_complexity }}
                                </div>
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="rotationSection">
                                <label
                                    title="Degrees from true north (+Y). Positive is counter-clockwise, negative is clockwise. Rotates outputs around the --center point and does not affect terrain.png."
                                    >Project North (Deg)</label
                                >
                                <input
                                    type="number"
                                    step="any"
                                    name="rotate_z"
                                    value="{{ defaults.rotate_z }}"
                                />
                            </div>
                            <div id="projectZeroSection">
                                <label
                                    >Project Zero (<span data-unit-label
                                        >feet</span
                                    >)</label
                                >
                                <input
                                    type="number"
                                    step="any"
                                    name="project_zero"
                                    value="{{ defaults.project_zero }}"
                                />
                            </div>
                        </div>

                        <div id="contourSmoothingSection">
                            <label>Contour Smoothing</label>
                            <div class="slider-row">
                                <input
                                    type="range"
                                    id="dxfSpacingRange"
                                    name="dxf_contour_spacing"
                                    min="0"
                                    max="10"
                                    step="1"
                                    value="{{ defaults.dxf_contour_spacing }}"
                                    oninput="
                                        document.getElementById(
                                            'dxfSpacingValue',
                                        ).textContent = this.value
                                    "
                                />
                                <div id="dxfSpacingValue">
                                    {{ defaults.dxf_contour_spacing }}
                                </div>
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="contourIntervalSection">
                                <label
                                    >Contour Interval (<span data-unit-label
                                        >feet</span
                                    >)</label
                                >
                                <div
                                    class="segmented"
                                    data-target="contour_interval"
                                >
                                    <button type="button" data-value="1">
                                        1
                                    </button>
                                    <button type="button" data-value="2">
                                        2
                                    </button>
                                    <button type="button" data-value="5">
                                        5
                                    </button>
                                    <button type="button" data-value="10">
                                        10
                                    </button>
                                </div>
                                <input
                                    type="hidden"
                                    id="contour_interval"
                                    name="contour_interval"
                                    value="{{ defaults.contour_interval }}"
                                />
                            </div>
                            <div id="contourLayersSection">
                                <label>Layers</label>
                                <div class="segmented contour-icons" data-toggle-group="layers">
                                    <button
                                        type="button"
                                        class="active static"
                                        title="Contours"
                                        aria-label="Contours"
                                        disabled
                                    >
                                        <i data-lucide="waves"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_parcels"
                                        title="Parcels"
                                        aria-label="Parcels"
                                    >
                                        <i data-lucide="layout-grid"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_buildings"
                                        title="Building Footprints"
                                        aria-label="Building Footprints"
                                    >
                                        <i data-lucide="house"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_roads"
                                        title="Roads (coming soon)"
                                        aria-label="Roads (coming soon)"
                                        disabled
                                    >
                                        <i data-lucide="route"></i>
                                    </button>
                                </div>
                                <input
                                    type="checkbox"
                                    id="dxf_include_parcels"
                                    name="dxf_include_parcels"
                                    class="visually-hidden"
                                    {%
                                    if
                                    defaults.dxf_include_parcels
                                    %}checked{%
                                    endif
                                    %}
                                />
                                <input
                                    type="checkbox"
                                    id="dxf_include_buildings"
                                    name="dxf_include_buildings"
                                    class="visually-hidden"
                                    {%
                                    if
                                    defaults.dxf_include_buildings
                                    %}checked{%
                                    endif
                                    %}
                                />
                                <input
                                    type="checkbox"
                                    id="dxf_include_roads"
                                    name="dxf_include_roads"
                                    class="visually-hidden"
                                    disabled
                                />
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="xyzSamplingSection">
                                <label>Point Cloud Mode</label>
                                <select id="xyz_mode" name="xyz_mode">
                                    <option value="contours" {% if defaults.xyz_mode is equalto 'contours' %}selected{% endif %}>Contours</option>
                                    <option value="grid" {% if defaults.xyz_mode is equalto 'grid' %}selected{% endif %}>Uniform Grid</option>
                                </select>
                            </div>
                            <div id="imageQualitySection">
                                <label>Satellite Image Quality</label>
                                <div
                                    class="segmented"
                                    data-target="image_quality"
                                >
                                    <button type="button" data-value="standard">
                                        S
                                    </button>
                                    <button type="button" data-value="high">
                                        M
                                    </button>
                                    <button type="button" data-value="ultra">
                                        L
                                    </button>
                                </div>
                                <input
                                    type="hidden"
                                    id="image_quality"
                                    name="image_quality"
                                    value="{{ defaults.image_quality }}"
                                />
                            </div>
                        </div>
                        <div id="buildingHeightsSection" class="grid two-col">
                            <div>
                                <label>Min Building Height</label>
                                <input
                                    type="number"
                                    step="any"
                                    name="random_min_height"
                                    value="{{ defaults.random_min_height }}"
                                />
                            </div>
                            <div>
                                <label>Max Building Height</label>
                                <input
                                    type="number"
                                    step="any"
                                    name="random_max_height"
                                    value="{{ defaults.random_max_height }}"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <div id="parcelAlert" class="status hidden"></div>
                    <div class="form-actions">
                        {% if can_build %}
                        <button class="btn" id="runBtn" type="submit">
                            Build
                        </button>
                        {% elif auth_enabled %}
                        <a class="btn" id="loginBtn" href="{{ url_for('auth_login', next='/') }}">
                            Login to Build
                        </a>
                        {% endif %}
                        <button class="btn secondary" type="reset">
                            Reset
                        </button>
                    </div>
                </div>
            </form>
            <div class="note data-sources">
                <span class="data-sources-label">Data sources:</span>
                <div class="data-source-group">
                    {% for source in data_sources %}
                    <a
                        class="data-pill"
                        href="{{ source.url }}"
                        target="_blank"
                        rel="noopener"
                        title="{{ source.details | join(', ') }}"
                        >{{ source.name }}</a
                    >
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <div class="section-title">Recent Jobs</div>
                <div id="recentJobs">
                    {% if not can_build %}
                    <p class="footer">Sign in to view your jobs and downloads.</p>
                    {% elif jobs %}
                    <ul>
                        {% for job in jobs %}
                        <li>
                            <a
                                href="{{ url_for('job_status', job_id=job.job_id) }}"
                                >{{ job.job_id }}</a
                            >
                            — {{ status_label(job.status) }}
                            {% if job.status == 'done' and job.summary.get('outputs') and job.summary.get('outputs').get('files') %}
                            —
                            {% for name in job.summary.get('outputs').get('files') %}
                            <a href="{{ url_for('job_download', job_id=job.job_id, name=name) }}">Download {{ name }}</a>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="footer">No jobs yet.</p>
                    {% endif %}
                </div>
            </div>
        </main>
        <i
            id="faviconSource"
            class="visually-hidden"
            data-lucide="mountain"
            aria-hidden="true"
        ></i>
        <script src="https://unpkg.com/lucide@latest"></script>
        <script>
            function setFaviconFromLucide() {
              const icon = document.getElementById('faviconSource');
              if (!icon || icon.tagName.toLowerCase() !== 'svg') return;
              const svg = icon.cloneNode(true);
              svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
              svg.setAttribute('width', '64');
              svg.setAttribute('height', '64');
              svg.style.color = '#e4e4e4';
              const encoded = encodeURIComponent(svg.outerHTML)
                .replace(/'/g, '%27')
                .replace(/"/g, '%22');
              const link = document.getElementById('favicon');
              if (link) {
                link.href = `data:image/svg+xml,${encoded}`;
              }
            }
            const VA_BOUNDS = { latMin: 36.5, latMax: 39.5, lonMin: -83.0, lonMax: -75.0 };
            const CONUS_BOUNDS = { latMin: 24.5, latMax: 49.5, lonMin: -125.0, lonMax: -66.5 };
            const PARCEL_SOURCES = {{ parcel_sources | tojson }};
            const RECENT_JOBS_POLL_MS = 5000;
            const CAN_BUILD = {{ can_build | tojson }};
            let buildErrorMessage = '';
            let coverageStatus = null;
            let coverageKey = null;
            let coverageTimer = null;
            let coverageRequestId = 0;

            function parseCoords(value) {
              if (!value) return null;
              const parts = value.split(/[\\s,]+/).map((p) => p.trim()).filter(Boolean);
              if (parts.length < 2) return null;
              const lat = Number(parts[0]);
              const lon = Number(parts[1]);
              if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
              return { lat, lon };
            }

            function getCoords() {
              const coordsInput = document.querySelector('input[name="coords"]');
              if (!coordsInput) return null;
              return parseCoords(coordsInput.value);
            }

            function coverageKeyFor(lon, lat) {
              return `${lon.toFixed(4)},${lat.toFixed(4)}`;
            }

            function isInVirginia(lon, lat) {
              return (
                lon >= VA_BOUNDS.lonMin &&
                lon <= VA_BOUNDS.lonMax &&
                lat >= VA_BOUNDS.latMin &&
                lat <= VA_BOUNDS.latMax
              );
            }

            function hasParcelCoverage(lon, lat) {
              if (!Array.isArray(PARCEL_SOURCES) || PARCEL_SOURCES.length === 0) {
                return false;
              }
              const inBBox = (bbox) => (
                lon >= bbox.xmin &&
                lon <= bbox.xmax &&
                lat >= bbox.ymin &&
                lat <= bbox.ymax
              );
              return PARCEL_SOURCES.some((source) => {
                if (Array.isArray(source.exclude)) {
                  for (const ex of source.exclude) {
                    if (inBBox(ex)) return false;
                  }
                }
                const cov = source.coverage;
                if (!cov) return true;
                return inBBox(cov);
              });
            }

            function isInConus(lon, lat) {
              return (
                lon >= CONUS_BOUNDS.lonMin &&
                lon <= CONUS_BOUNDS.lonMax &&
                lat >= CONUS_BOUNDS.latMin &&
                lat <= CONUS_BOUNDS.latMax
              );
            }

            async function checkCoverage() {
              const coords = getCoords();
              if (!coords) {
                coverageStatus = null;
                coverageKey = null;
                updateAlerts();
                return;
              }
              const key = coverageKeyFor(coords.lon, coords.lat);
              const reqId = ++coverageRequestId;
              try {
                const resp = await fetch(`/coverage?lon=${coords.lon}&lat=${coords.lat}`, { cache: 'no-store' });
                if (!resp.ok) throw new Error('coverage failed');
                const data = await resp.json();
                if (reqId !== coverageRequestId) return;
                if (data.supported === true) {
                  coverageStatus = true;
                } else if (data.supported === false) {
                  coverageStatus = false;
                } else {
                  coverageStatus = null;
                }
                coverageKey = key;
              } catch (err) {
                if (reqId !== coverageRequestId) return;
                coverageStatus = null;
                coverageKey = null;
              }
              updateAlerts();
            }

            function scheduleCoverageCheck() {
              if (coverageTimer) {
                clearTimeout(coverageTimer);
              }
              coverageTimer = setTimeout(checkCoverage, 400);
            }

            function setAlert(message, isError) {
              const alertEl = document.getElementById('parcelAlert');
              if (!alertEl) return;
              if (!message) {
                alertEl.classList.add('hidden');
                alertEl.classList.remove('error');
                alertEl.textContent = '';
                return;
              }
              alertEl.textContent = message;
              alertEl.classList.remove('hidden');
              if (isError) {
                alertEl.classList.add('error');
              } else {
                alertEl.classList.remove('error');
              }
            }

            function updateAlerts() {
              const parcels = document.getElementById('dxf_include_parcels');
              const contours = document.getElementById('output_contours');
              const coordsInput = document.querySelector('input[name="coords"]');
              const coords = coordsInput ? parseCoords(coordsInput.value) : null;
              if (coordsInput && coordsInput.value.trim() && !coords) {
                setAlert('Coordinates are invalid. Use “lat, lon”.', true);
                return;
              }
              if (coords && !isInConus(coords.lon, coords.lat)) {
                setAlert('Coordinates are outside the supported area (contiguous US).', true);
                return;
              }
              if (
                coverageStatus === false &&
                coords &&
                coverageKey === coverageKeyFor(coords.lon, coords.lat)
              ) {
                setAlert('Coordinates are outside the supported area (contiguous US).', true);
                return;
              }
              const parcelsRequested = Boolean(
                parcels &&
                contours &&
                contours.checked &&
                parcels.checked
              );
              if (parcelsRequested && coords && !hasParcelCoverage(coords.lon, coords.lat)) {
                setAlert('No parcel data available for this location.', true);
                return;
              }
              if (buildErrorMessage) {
                setAlert(buildErrorMessage, true);
                return;
              }
              setAlert('', false);
            }

            function renderRecentJobs(container, jobs) {
              container.innerHTML = '';
              if (!jobs || jobs.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'footer';
                empty.textContent = 'No jobs yet.';
                container.appendChild(empty);
                return;
              }
              const list = document.createElement('ul');
              jobs.forEach((job) => {
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.href = `/jobs/${job.job_id}`;
                link.textContent = job.job_id;
                item.appendChild(link);
                const label = job.status_label || job.status;
                item.appendChild(document.createTextNode(` — ${label}`));
                if (Array.isArray(job.downloads) && job.downloads.length > 0) {
                  item.appendChild(document.createTextNode(' — '));
                  job.downloads.forEach((download, idx) => {
                    const dl = document.createElement('a');
                    dl.href = download.url;
                    dl.textContent = `Download ${download.name}`;
                    item.appendChild(dl);
                    if (idx < job.downloads.length - 1) {
                      item.appendChild(document.createTextNode(', '));
                    }
                  });
                }
                list.appendChild(item);
              });
              container.appendChild(list);
            }

            async function refreshRecentJobs() {
              if (!CAN_BUILD) return;
              const container = document.getElementById('recentJobs');
              if (!container) return;
              try {
                const resp = await fetch('/recent-jobs', { cache: 'no-store' });
                if (!resp.ok) return;
                const data = await resp.json();
                renderRecentJobs(container, data.jobs || []);
              } catch (err) {
                return;
              }
            }

            function startRecentJobsPolling() {
              if (window.__recentJobsPoll) return;
              window.__recentJobsPoll = setInterval(refreshRecentJobs, RECENT_JOBS_POLL_MS);
            }

            function updateUnitLabels() {
              const unitsInput = document.querySelector('select[name="units"]');
              const unitValue = unitsInput ? unitsInput.value : 'feet';
              const label = unitValue === 'meters' ? 'meters' : 'feet';
              document.querySelectorAll('[data-unit-label]').forEach((el) => {
                el.textContent = label;
              });
            }

            function initSegmentedControls() {
              document.querySelectorAll('.segmented[data-target]').forEach((segmented) => {
                const inputId = segmented.dataset.target;
                const input = document.getElementById(inputId);
                const buttons = Array.from(segmented.querySelectorAll('button[data-value]'));
                if (!input || buttons.length === 0) return;
                const bound = segmented.dataset.bound === 'true';
                const values = buttons.map((btn) => btn.dataset.value);
                let current = input.value;
                if (!values.includes(current)) {
                  if (inputId === 'contour_interval') {
                    const numeric = Number(current);
                    let best = values[0];
                    let bestDelta = Infinity;
                    values.forEach((value) => {
                      const delta = Math.abs(Number(value) - numeric);
                      if (delta < bestDelta) {
                        bestDelta = delta;
                        best = value;
                      }
                    });
                    current = best;
                  } else {
                    current = values[0];
                  }
                  input.value = current;
                }
                const setActive = (value) => {
                  input.value = value;
                  buttons.forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.value === value);
                  });
                };
                setActive(current);
                if (!bound) {
                  buttons.forEach((btn) => {
                    btn.addEventListener('click', () => setActive(btn.dataset.value));
                  });
                  segmented.dataset.bound = 'true';
                }
              });
            }

            function syncToggleButtons() {
              document.querySelectorAll('button[data-input]').forEach((btn) => {
                const input = document.getElementById(btn.dataset.input);
                if (!input) return;
                btn.classList.toggle('active', input.checked);
                btn.setAttribute('aria-pressed', input.checked ? 'true' : 'false');
                btn.disabled = input.disabled;
              });
            }

            function initToggleButtons() {
              document.querySelectorAll('button[data-input]').forEach((btn) => {
                if (btn.dataset.bound === 'true') return;
                const input = document.getElementById(btn.dataset.input);
                if (!input) return;
                btn.addEventListener('click', () => {
                  if (btn.disabled) return;
                  input.checked = !input.checked;
                  syncToggleButtons();
                  updateAlerts();
                });
                btn.dataset.bound = 'true';
              });
              syncToggleButtons();
            }

            function setSectionLocked(sectionId, locked) {
              const section = document.getElementById(sectionId);
              if (!section) return;
              section.classList.toggle('locked', locked);
            }

            function updateUiToggles() {
              const contours = document.getElementById('output_contours');
              const outTerrain = document.getElementById('output_terrain');
              const outBuildings = document.getElementById('output_buildings');
              const outImage = document.getElementById('output_naip');
              const outXyz = document.getElementById('output_xyz');
              const xyzMode = document.getElementById('xyz_mode');
              const dxfParcels = document.getElementById('dxf_include_parcels');
              const dxfBuildings = document.getElementById('dxf_include_buildings');

              const contoursActive = contours && contours.checked;
              const xyzActive = outXyz && outXyz.checked;
              const terrainActive = outTerrain && outTerrain.checked;
              const buildingsActive = outBuildings && outBuildings.checked;
              const rotationActive = terrainActive || buildingsActive || contoursActive || xyzActive;
              const projectZeroActive = rotationActive;
              const xyzModeIsContours = xyzMode && xyzMode.value === 'contours';
              const showContourControls = contoursActive || (xyzActive && xyzModeIsContours);

              setSectionLocked('meshResolutionSection', false);
              setSectionLocked('buildingHeightsSection', !buildingsActive);
              setSectionLocked('contourIntervalSection', !showContourControls);
              setSectionLocked('contourLayersSection', !contoursActive);
              setSectionLocked('contourSmoothingSection', !contoursActive);
              setSectionLocked('xyzSamplingSection', !xyzActive);
              setSectionLocked('imageQualitySection', !(outImage && outImage.checked));
              setSectionLocked('rotationSection', !rotationActive);
              setSectionLocked('projectZeroSection', !projectZeroActive);

              if (dxfParcels) dxfParcels.disabled = !contoursActive;
              if (dxfBuildings) dxfBuildings.disabled = !contoursActive;
              const parcelsBtn = document.querySelector('button[data-input="dxf_include_parcels"]');
              const buildingsBtn = document.querySelector('button[data-input="dxf_include_buildings"]');
              if (parcelsBtn) parcelsBtn.disabled = !contoursActive;
              if (buildingsBtn) buildingsBtn.disabled = !contoursActive;

              const dxfRange = document.getElementById('dxfSpacingRange');
              const dxfValue = document.getElementById('dxfSpacingValue');
              if (dxfRange && dxfValue) {
                dxfRange.disabled = !contoursActive;
                dxfValue.textContent = dxfRange.value;
              }
              const complexityInput = document.querySelector('input[name="terrain_complexity"]');
              const complexityValue = document.getElementById('complexityValue');
              if (complexityInput && complexityValue) {
                complexityValue.textContent = complexityInput.value;
              }

              updateAlerts();
              syncToggleButtons();
            }


            async function runBuild(event) {
              event.preventDefault();
              const form = event.target;
              const runBtn = document.getElementById('runBtn');
              if (!form || !runBtn) return;

              buildErrorMessage = '';
              updateAlerts();
              runBtn.disabled = true;
              const originalText = runBtn.textContent;
              runBtn.textContent = 'Running...';

              const formData = new FormData(form);
              const resp = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'fetch' },
              });
              if (!resp.ok) {
                try {
                  const payload = await resp.json();
                  buildErrorMessage = payload.error || 'Build failed to start. Please check your inputs and try again.';
                } catch (err) {
                  buildErrorMessage = 'Build failed to start. Please check your inputs and try again.';
                }
                updateAlerts();
                runBtn.disabled = false;
                runBtn.textContent = originalText;
                return;
              }
              const data = await resp.json();

              let offset = 0;
              async function poll() {
                const logResp = await fetch(`/logs/${data.job_id}?offset=${offset}`);
                if (!logResp.ok) return;
                const logData = await logResp.json();
                offset = logData.offset;
                if (logData.status === 'running') {
                  setTimeout(poll, 1500);
                } else {
                  if (logData.status === 'error') {
                    const reason = logData.error ? ` ${logData.error}` : '';
                    buildErrorMessage = `Build failed.${reason}`;
                    updateAlerts();
                  }
                  refreshRecentJobs();
                  runBtn.disabled = false;
                  runBtn.textContent = originalText;
                }
              }
              poll();
            }

            document.addEventListener('DOMContentLoaded', () => {
              const profileShell = document.getElementById('profileShell');
              const profileButton = document.getElementById('profileButton');
              const profileDropdown = document.getElementById('profileDropdown');
              if (profileShell && profileButton && profileDropdown) {
                const closeProfileMenu = () => {
                  profileDropdown.classList.add('hidden');
                  profileButton.setAttribute('aria-expanded', 'false');
                };
                profileButton.addEventListener('click', (event) => {
                  event.preventDefault();
                  event.stopPropagation();
                  const willOpen = profileDropdown.classList.contains('hidden');
                  if (willOpen) {
                    profileDropdown.classList.remove('hidden');
                    profileButton.setAttribute('aria-expanded', 'true');
                  } else {
                    closeProfileMenu();
                  }
                });
                document.addEventListener('click', (event) => {
                  if (!profileShell.contains(event.target)) {
                    closeProfileMenu();
                  }
                });
                document.addEventListener('keydown', (event) => {
                  if (event.key === 'Escape') {
                    closeProfileMenu();
                  }
                });
              }

              initSegmentedControls();
              initToggleButtons();
              updateUnitLabels();
              updateUiToggles();
              if (window.lucide) {
                lucide.createIcons();
                setFaviconFromLucide();
              }
              const contours = document.getElementById('output_contours');
              const outTerrain = document.getElementById('output_terrain');
              const outBuildings = document.getElementById('output_buildings');
              const outImage = document.getElementById('output_naip');
              const outXyz = document.getElementById('output_xyz');
              const xyzMode = document.getElementById('xyz_mode');
              const dxfParcels = document.getElementById('dxf_include_parcels');
              const coords = document.querySelector('input[name="coords"]');
              const units = document.querySelector('select[name="units"]');
              if (contours) contours.addEventListener('change', updateUiToggles);
              if (dxfParcels) dxfParcels.addEventListener('change', updateAlerts);
              if (outTerrain) outTerrain.addEventListener('change', updateUiToggles);
              if (outBuildings) outBuildings.addEventListener('change', updateUiToggles);
              if (outImage) outImage.addEventListener('change', updateUiToggles);
              if (outXyz) outXyz.addEventListener('change', updateUiToggles);
              if (xyzMode) xyzMode.addEventListener('change', updateUiToggles);
              if (coords) coords.addEventListener('input', () => {
                updateAlerts();
                scheduleCoverageCheck();
              });
              if (units) units.addEventListener('change', () => {
                updateUnitLabels();
              });
              const form = document.querySelector('form.card');
              if (form) {
                if (CAN_BUILD) {
                  form.addEventListener('submit', runBuild);
                }
                form.addEventListener('reset', () => {
                  setTimeout(() => {
                    initSegmentedControls();
                    initToggleButtons();
                    updateUnitLabels();
                    updateUiToggles();
                    updateAlerts();
                    scheduleCoverageCheck();
                  }, 0);
                });
              }
              if (CAN_BUILD) {
                refreshRecentJobs();
                startRecentJobsPolling();
              }
              scheduleCoverageCheck();
            });
        </script>
    </body>
</html>
