<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Terrain Modeler</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='app.css') }}"
        />
    </head>
    <body>
        <header>
            <h1>Terrain Modeler</h1>
            <p class="sub">
                Generate site context and contour models for anywhere in the
                USA.
            </p>
        </header>
        <main>
            <form
                class="card app-card"
                method="post"
                action="{{ url_for('run_job') }}"
            >
                <div class="form-body">
                    <div class="section-title">Location</div>
                    <div class="grid">
                        <div style="grid-column: 1 / -1">
                            <label>Coordinates</label>
                            <input
                                type="text"
                                name="coords"
                                value="{{ defaults.center1 }}, {{ defaults.center2 }}"
                                placeholder="lat, lon"
                            />
                        </div>
                        <div>
                            <label>Map Size (Square)</label>
                            <input
                                type="number"
                                step="any"
                                name="size"
                                value="{{ defaults.clip_size }}"
                            />
                        </div>
                        <div>
                            <label>Units</label>
              <select name="units">
                <option value="feet" {% if defaults.units == 'feet' %}selected{% endif %}>
                  feet
                </option>
                <option value="meters" {% if defaults.units == 'meters' %}selected{% endif %}>
                  meters
                </option>
              </select>
                        </div>
                    </div>
                    <div class="note" style="margin-top: 8px">
                        Provider:
                        <span id="providerValue"
                            >{{ defaults.provider_label }}</span
                        >
                    </div>

                    <div class="section-title" style="margin-top: 16px">
                        Outputs
                    </div>
                    <div class="check-row">
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_terrain"
                                name="output_terrain"
                                {%
                                if
                                defaults.output_terrain
                                %}checked{%
                                endif
                                %}
                            />
                            Terrain Mesh</label
                        >
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_buildings"
                                name="output_buildings"
                                {%
                                if
                                defaults.output_buildings
                                %}checked{%
                                endif
                                %}
                            />
                            Buildings</label
                        >
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_combined"
                                name="output_combined"
                                {%
                                if
                                defaults.output_combined
                                %}checked{%
                                endif
                                %}
                            />
                            Combined OBJ</label
                        >
                    </div>
                    <div class="check-row" style="margin-top: 6px">
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_contours"
                                name="output_contours"
                                {%
                                if
                                defaults.output_contours
                                %}checked{%
                                endif
                                %}
                            />
                            Contours</label
                        >
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_parcels"
                                name="output_parcels"
                                {%
                                if
                                defaults.output_parcels
                                %}checked{%
                                endif
                                %}
                            />
                            Parcels</label
                        >
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_naip"
                                name="output_naip"
                                {%
                                if
                                defaults.output_naip
                                %}checked{%
                                endif
                                %}
                            />
                            NAIP Texture</label
                        >
                        <label class="check"
                            ><input
                                type="checkbox"
                                id="output_xyz"
                                name="output_xyz"
                                {%
                                if
                                defaults.output_xyz
                                %}checked{%
                                endif
                                %}
                            />
                            XYZ Points</label
                        >
                    </div>
                    <div id="combinedNote" class="inline-note hidden">
                        Requires Terrain + Buildings outputs.
                    </div>

                    <div id="advancedControls" class="advanced-controls">
                        <div id="meshResolutionSection">
                            <div class="section-title" style="margin-top: 16px">
                                Mesh Resolution
                            </div>
                            <div class="grid" style="margin-top: 6px">
                                <div
                                    style="
                                        grid-column: 1 / -1;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                    "
                                >
                                    <input
                                        type="range"
                                        min="0"
                                        max="10"
                                        step="1"
                                        name="terrain_complexity"
                                        value="{{ defaults.terrain_complexity }}"
                                        oninput="
                                            document.getElementById(
                                                'complexityValue',
                                            ).textContent = this.value;
                                            updateComplexityEstimate();
                                        "
                                    />
                                    <div
                                        id="complexityValue"
                                        style="
                                            min-width: 20px;
                                            text-align: right;
                                        "
                                    >
                                        {{ defaults.terrain_complexity }}
                                    </div>
                                </div>
                            </div>
                            <div
                                class="note"
                                id="complexityEstimate"
                                style="margin-top: 6px"
                            ></div>
                        </div>

                        <div id="rotationSection">
                            <div class="section-title" style="margin-top: 16px">
                                Rotation
                            </div>
                            <div class="grid" style="margin-top: 6px">
                                <div>
                                    <label
                                        title="Degrees from true north (+Y). Positive is counter-clockwise, negative is clockwise. Rotates outputs around the --center point and does not affect terrain.png."
                                        >Rotation (deg)</label
                                    >
                                    <input
                                        type="number"
                                        step="any"
                                        name="rotate_z"
                                        value="{{ defaults.rotate_z }}"
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="buildingHeightsSection">
                            <div class="section-title" style="margin-top: 16px">
                                Building Heights
                            </div>
                            <div class="grid" style="margin-top: 6px">
                                <div>
                                    <label>Random Min Height</label>
                                    <input
                                        type="number"
                                        step="any"
                                        name="random_min_height"
                                        value="{{ defaults.random_min_height }}"
                                    />
                                </div>
                                <div>
                                    <label>Random Max Height</label>
                                    <input
                                        type="number"
                                        step="any"
                                        name="random_max_height"
                                        value="{{ defaults.random_max_height }}"
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="contourIntervalSection">
                            <div class="section-title" style="margin-top: 16px">
                                Contour Interval
                            </div>
                            <div class="grid" id="contourIntervalRow">
                                <div>
                                    <input
                                        type="number"
                                        step="any"
                                        name="contour_interval"
                                        value="{{ defaults.contour_interval }}"
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="imageQualitySection">
                            <div class="section-title" style="margin-top: 16px">
                                Image Quality
                            </div>
                            <div class="grid" style="margin-top: 6px">
                                <div>
                                    <select id="image_quality" name="image_quality">
                                        <option value="standard" {% if defaults.image_quality == 'standard' %}selected{% endif %}>
                                            Standard
                                        </option>
                                        <option value="high" {% if defaults.image_quality == 'high' %}selected{% endif %}>
                                            High
                                        </option>
                                        <option value="ultra" {% if defaults.image_quality == 'ultra' %}selected{% endif %}>
                                            Ultra
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <div id="parcelAlert" class="status hidden"></div>
                    <div class="form-actions">
                        <button class="btn" id="runBtn" type="submit">
                            Build
                        </button>
                        <button class="btn secondary" type="reset">
                            Reset
                        </button>
                    </div>
                </div>
            </form>
            <div class="note" style="margin-top: 20px; text-align: center">
                Data sources: VGIN LiDAR/Footprints (VA mode), USGS 3DEP LiDAR +
                Microsoft Footprints (National mode), and NAIP imagery.
            </div>

            <div class="card">
                <div class="section-title">Recent Jobs</div>
                <div id="recentJobs">
                    {% if jobs %}
                    <ul>
                        {% for job in jobs %}
                        <li>
                            <a
                                href="{{ url_for('job_status', job_id=job.job_id) }}"
                                >{{ job.job_id }}</a
                            >
                            — {{ status_label(job.status) }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="footer">No jobs yet.</p>
                    {% endif %}
                </div>
            </div>
        </main>
        <script>
            const VA_BOUNDS = { latMin: 36.5, latMax: 39.5, lonMin: -83.0, lonMax: -75.0 };
            const CONUS_BOUNDS = { latMin: 24.5, latMax: 49.5, lonMin: -125.0, lonMax: -66.5 };
            const PARCEL_SOURCES = {{ parcel_sources | tojson }};
            const RECENT_JOBS_POLL_MS = 5000;
            let buildErrorMessage = '';
            let coverageStatus = null;
            let coverageKey = null;
            let coverageTimer = null;
            let coverageRequestId = 0;

            function parseCoords(value) {
              if (!value) return null;
              const parts = value.split(/[\\s,]+/).map((p) => p.trim()).filter(Boolean);
              if (parts.length < 2) return null;
              const lat = Number(parts[0]);
              const lon = Number(parts[1]);
              if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
              return { lat, lon };
            }

            function getCoords() {
              const coordsInput = document.querySelector('input[name="coords"]');
              if (!coordsInput) return null;
              return parseCoords(coordsInput.value);
            }

            function coverageKeyFor(lon, lat) {
              return `${lon.toFixed(4)},${lat.toFixed(4)}`;
            }

            function isInVirginia(lon, lat) {
              return (
                lon >= VA_BOUNDS.lonMin &&
                lon <= VA_BOUNDS.lonMax &&
                lat >= VA_BOUNDS.latMin &&
                lat <= VA_BOUNDS.latMax
              );
            }

            function updateProviderLabel() {
              const providerEl = document.getElementById('providerValue');
              if (!providerEl) return;
              const coords = getCoords();
              if (!coords) {
                providerEl.textContent = 'VGIN (Virginia)';
                return;
              }
              providerEl.textContent = isInVirginia(coords.lon, coords.lat)
                ? 'VGIN (Virginia)'
                : 'USGS 3DEP (National)';
            }

            function hasParcelCoverage(lon, lat) {
              if (!Array.isArray(PARCEL_SOURCES) || PARCEL_SOURCES.length === 0) {
                return false;
              }
              const inBBox = (bbox) => (
                lon >= bbox.xmin &&
                lon <= bbox.xmax &&
                lat >= bbox.ymin &&
                lat <= bbox.ymax
              );
              return PARCEL_SOURCES.some((source) => {
                if (Array.isArray(source.exclude)) {
                  for (const ex of source.exclude) {
                    if (inBBox(ex)) return false;
                  }
                }
                const cov = source.coverage;
                if (!cov) return true;
                return inBBox(cov);
              });
            }

            function isInConus(lon, lat) {
              return (
                lon >= CONUS_BOUNDS.lonMin &&
                lon <= CONUS_BOUNDS.lonMax &&
                lat >= CONUS_BOUNDS.latMin &&
                lat <= CONUS_BOUNDS.latMax
              );
            }

            async function checkCoverage() {
              const coords = getCoords();
              if (!coords) {
                coverageStatus = null;
                coverageKey = null;
                updateAlerts();
                return;
              }
              const key = coverageKeyFor(coords.lon, coords.lat);
              const reqId = ++coverageRequestId;
              try {
                const resp = await fetch(`/coverage?lon=${coords.lon}&lat=${coords.lat}`, { cache: 'no-store' });
                if (!resp.ok) throw new Error('coverage failed');
                const data = await resp.json();
                if (reqId !== coverageRequestId) return;
                if (data.supported === true) {
                  coverageStatus = true;
                } else if (data.supported === false) {
                  coverageStatus = false;
                } else {
                  coverageStatus = null;
                }
                coverageKey = key;
              } catch (err) {
                if (reqId !== coverageRequestId) return;
                coverageStatus = null;
                coverageKey = null;
              }
              updateAlerts();
            }

            function scheduleCoverageCheck() {
              if (coverageTimer) {
                clearTimeout(coverageTimer);
              }
              coverageTimer = setTimeout(checkCoverage, 400);
            }

            function setAlert(message, isError) {
              const alertEl = document.getElementById('parcelAlert');
              if (!alertEl) return;
              if (!message) {
                alertEl.classList.add('hidden');
                alertEl.classList.remove('error');
                alertEl.textContent = '';
                return;
              }
              alertEl.textContent = message;
              alertEl.classList.remove('hidden');
              if (isError) {
                alertEl.classList.add('error');
              } else {
                alertEl.classList.remove('error');
              }
            }

            function updateAlerts() {
              const parcels = document.getElementById('output_parcels');
              if (!parcels) {
                setAlert('', false);
                return;
              }
              const coordsInput = document.querySelector('input[name="coords"]');
              const coords = coordsInput ? parseCoords(coordsInput.value) : null;
              if (coordsInput && coordsInput.value.trim() && !coords) {
                setAlert('Coordinates are invalid. Use “lat, lon”.', true);
                return;
              }
              if (coords && !isInConus(coords.lon, coords.lat)) {
                setAlert('Coordinates are outside the supported area (contiguous US).', true);
                return;
              }
              if (
                coverageStatus === false &&
                coords &&
                coverageKey === coverageKeyFor(coords.lon, coords.lat)
              ) {
                setAlert('Coordinates are outside the supported area (contiguous US).', true);
                return;
              }
              if (
                parcels.checked &&
                coords &&
                !hasParcelCoverage(coords.lon, coords.lat)
              ) {
                setAlert('No parcel data available for this location.', true);
                return;
              }
              if (buildErrorMessage) {
                setAlert(buildErrorMessage, true);
                return;
              }
              setAlert('', false);
            }

            function renderRecentJobs(container, jobs) {
              container.innerHTML = '';
              if (!jobs || jobs.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'footer';
                empty.textContent = 'No jobs yet.';
                container.appendChild(empty);
                return;
              }
              const list = document.createElement('ul');
              jobs.forEach((job) => {
                const item = document.createElement('li');
                const link = document.createElement('a');
                link.href = `/jobs/${job.job_id}`;
                link.textContent = job.job_id;
                item.appendChild(link);
                const label = job.status_label || job.status;
                item.appendChild(document.createTextNode(` — ${label}`));
                list.appendChild(item);
              });
              container.appendChild(list);
            }

            async function refreshRecentJobs() {
              const container = document.getElementById('recentJobs');
              if (!container) return;
              try {
                const resp = await fetch('/recent-jobs', { cache: 'no-store' });
                if (!resp.ok) return;
                const data = await resp.json();
                renderRecentJobs(container, data.jobs || []);
              } catch (err) {
                return;
              }
            }

            function startRecentJobsPolling() {
              if (window.__recentJobsPoll) return;
              window.__recentJobsPoll = setInterval(refreshRecentJobs, RECENT_JOBS_POLL_MS);
            }

            function formatCount(value) {
              if (value >= 1e6) return `${(value / 1e6).toFixed(1)}M`;
              if (value >= 1e3) return `${Math.round(value / 1e3)}k`;
              return `${Math.round(value)}`;
            }

            function updateComplexityEstimate() {
              const estimateEl = document.getElementById('complexityEstimate');
              const sizeInput = document.querySelector('input[name="size"]');
              const unitsInput = document.querySelector('select[name="units"]');
              const complexityInput = document.querySelector('input[name="terrain_complexity"]');
              const outTerrain = document.getElementById('output_terrain');
              if (!estimateEl || !sizeInput || !complexityInput || !outTerrain) return;

              if (!outTerrain.checked) {
                estimateEl.textContent = '';
                return;
              }

              const size = Number(sizeInput.value);
              const complexityValue = Number(complexityInput.value || 0);
              const units = unitsInput ? unitsInput.value : 'feet';
              if (!Number.isFinite(size) || size <= 0) {
                estimateEl.textContent = 'Estimated mesh polygons: —';
                return;
              }

              const terrainSample = Math.max(1, 11 - Math.round(complexityValue));
              const baseResolution = Number({{ defaults.resolution }}) || 1;
              const metersToFeet = 3.28084;
              let cellSize = baseResolution * terrainSample;
              if (units === 'feet') {
                cellSize *= metersToFeet;
              }
              if (!Number.isFinite(cellSize) || cellSize <= 0) {
                estimateEl.textContent = 'Estimated mesh polygons: —';
                return;
              }
              const samplesPerSide = Math.max(2, Math.floor(size / cellSize));
              const faces = 2 * Math.pow(samplesPerSide - 1, 2);
              estimateEl.textContent = `Estimated mesh polygons: ~${formatCount(faces)}`;
            }

            const advancedState = {};

            function setAdvancedVisibility(sectionId, checked) {
              const section = document.getElementById(sectionId);
              const container = document.getElementById('advancedControls');
              if (!section || !container) return;
              const prev = advancedState[sectionId];
              if (checked) {
                section.classList.remove('hidden');
                if (!prev) {
                  container.appendChild(section);
                }
              } else {
                section.classList.add('hidden');
              }
              advancedState[sectionId] = checked;
            }

            function updateUiToggles() {
              const contours = document.getElementById('output_contours');
              const parcels = document.getElementById('output_parcels');
              const outTerrain = document.getElementById('output_terrain');
              const outBuildings = document.getElementById('output_buildings');
              const outImage = document.getElementById('output_naip');
              const outCombined = document.getElementById('output_combined');
              const combinedNote = document.getElementById('combinedNote');
              if (outTerrain) setAdvancedVisibility('meshResolutionSection', outTerrain.checked);
              if (outBuildings) setAdvancedVisibility('buildingHeightsSection', outBuildings.checked);
              if (contours) setAdvancedVisibility('contourIntervalSection', contours.checked);
              if (outImage) setAdvancedVisibility('imageQualitySection', outImage.checked);
              if (outCombined && outTerrain && outBuildings) {
                const canCombine = outTerrain.checked && outBuildings.checked;
                outCombined.disabled = !canCombine;
                if (!canCombine) outCombined.checked = false;
                if (combinedNote) {
                  combinedNote.classList.toggle('hidden', canCombine);
                }
              }
              if (parcels) updateAlerts();
              updateComplexityEstimate();
              updateProviderLabel();
            }

            async function runBuild(event) {
              event.preventDefault();
              const form = event.target;
              const runBtn = document.getElementById('runBtn');
              if (!form || !runBtn) return;

              buildErrorMessage = '';
              updateAlerts();
              runBtn.disabled = true;
              const originalText = runBtn.textContent;
              runBtn.textContent = 'Running...';

              const formData = new FormData(form);
              const resp = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'fetch' },
              });
              if (!resp.ok) {
                buildErrorMessage = 'Build failed to start. Please check your inputs and try again.';
                updateAlerts();
                runBtn.disabled = false;
                runBtn.textContent = originalText;
                return;
              }
              const data = await resp.json();

              let offset = 0;
              async function poll() {
                const logResp = await fetch(`/logs/${data.job_id}?offset=${offset}`);
                if (!logResp.ok) return;
                const logData = await logResp.json();
                offset = logData.offset;
                if (logData.status === 'running') {
                  setTimeout(poll, 1500);
                } else {
                  if (logData.status === 'error') {
                    const reason = logData.error ? ` ${logData.error}` : '';
                    buildErrorMessage = `Build failed.${reason}`;
                    updateAlerts();
                  }
                  refreshRecentJobs();
                  runBtn.disabled = false;
                  runBtn.textContent = originalText;
                }
              }
              poll();
            }

            document.addEventListener('DOMContentLoaded', () => {
              updateUiToggles();
              const contours = document.getElementById('output_contours');
              const parcels = document.getElementById('output_parcels');
              const outTerrain = document.getElementById('output_terrain');
              const outBuildings = document.getElementById('output_buildings');
              const outImage = document.getElementById('output_naip');
              const outCombined = document.getElementById('output_combined');
              const coords = document.querySelector('input[name="coords"]');
              const size = document.querySelector('input[name="size"]');
              const units = document.querySelector('select[name="units"]');
              if (contours) contours.addEventListener('change', updateUiToggles);
              if (parcels) parcels.addEventListener('change', updateAlerts);
              if (outTerrain) outTerrain.addEventListener('change', updateUiToggles);
              if (outBuildings) outBuildings.addEventListener('change', updateUiToggles);
              if (outImage) outImage.addEventListener('change', updateUiToggles);
              if (outCombined) outCombined.addEventListener('change', updateUiToggles);
              if (coords) coords.addEventListener('input', () => {
                updateProviderLabel();
                updateAlerts();
                scheduleCoverageCheck();
              });
              if (size) size.addEventListener('input', updateComplexityEstimate);
              if (units) units.addEventListener('change', updateComplexityEstimate);
              const form = document.querySelector('form.card');
              if (form) {
                form.addEventListener('submit', runBuild);
                form.addEventListener('reset', () => {
                  setTimeout(() => {
                    updateUiToggles();
                    updateAlerts();
                    scheduleCoverageCheck();
                  }, 0);
                });
              }
              refreshRecentJobs();
              startRecentJobsPolling();
              scheduleCoverageCheck();
            });
        </script>
    </body>
</html>
