<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Terrain Modeler</title>
        <link rel="icon" type="image/svg+xml" id="favicon" href="data:," />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='app.css') }}"
        />
    </head>
    <body>
        {% if auth_enabled and current_user %}
        {% set profile_name = current_user.get('name') or ((current_user.get('email') or '').split('@')[0]) or 'User' %}
        {% set profile_initial = (profile_name[:1] if profile_name else 'U')|upper %}
        <div id="profileShell" class="profile-shell">
            <button
                type="button"
                id="profileButton"
                class="profile-button"
                aria-label="Account menu"
                aria-haspopup="menu"
                aria-expanded="false"
                aria-controls="profileDropdown"
            >
                {{ profile_initial }}
            </button>
            <div id="profileDropdown" class="profile-dropdown hidden" role="menu" aria-labelledby="profileButton">
                <p class="profile-row">
                    Signed in as <strong>{{ current_user.email }}</strong>
                </p>
                {% if current_user.is_admin %}
                <a class="profile-link" href="{{ url_for('bp.admin_users') }}">Admin</a>
                {% endif %}
                <form method="post" action="{{ url_for('bp.auth_logout') }}" class="profile-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button class="btn secondary profile-logout" type="submit">Sign out</button>
                </form>
            </div>
        </div>
        {% endif %}
        <header>
            <h1>Terrain Modeler</h1>
            <p class="sub">
                Generate site context and contour models for anywhere in the
                USA.
            </p>
        </header>
        <main>
            <form
                class="card app-card"
                method="post"
                action="{{ url_for('bp.run_job') }}"
            >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="form-body">
                    <div class="section-title">Location</div>
                    <div class="grid">
                        <div>
                            <label>Coordinates</label>
                            <input
                                type="text"
                                name="coords"
                                value="{{ defaults.center1 }}, {{ defaults.center2 }}"
                                placeholder="lat, lon"
                            />
                        </div>
                        <div>
                            <label>Name (Optional)</label>
                            <input
                                type="text"
                                name="job_name"
                                value="{{ defaults.job_name }}"
                                placeholder="Custom name"
                                maxlength="120"
                            />
                        </div>
                        <div>
                            <label>Map Size (Square)</label>
                            <input
                                type="number"
                                step="any"
                                name="size"
                                value="{{ defaults.clip_size }}"
                            />
                        </div>
                        <div>
                            <label>Units</label>
                            <select name="units">
                                <option value="feet" {% if defaults.units is equalto 'feet' %}selected{% endif %}>feet</option>
                                <option value="meters" {% if defaults.units is equalto 'meters' %}selected{% endif %}>meters</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title" style="margin-top: 16px">
                        Outputs
                    </div>
                    <div class="check-row">
                        <label class="check" title="contours.dxf (DXF)"
                            ><input
                                type="checkbox"
                                id="output_contours"
                                name="output_contours"
                                {%
                                if
                                defaults.output_contours
                                %}checked{%
                                endif
                                %}
                            />
                            Contours</label
                        >
                        <label class="check" title="terrain.xyz (XYZ)"
                            ><input
                                type="checkbox"
                                id="output_xyz"
                                name="output_xyz"
                                {%
                                if
                                defaults.output_xyz
                                %}checked{%
                                endif
                                %}
                            />
                            Point Cloud</label
                        >
                        <label class="check" title="terrain.png (PNG)"
                            ><input
                                type="checkbox"
                                id="output_naip"
                                name="output_naip"
                                {%
                                if
                                defaults.output_naip
                                %}checked{%
                                endif
                                %}
                            />
                            Satellite Image</label
                        >
                    </div>
                    <div class="check-row" style="margin-top: 6px">
                        <label class="check" title="terrain.obj (OBJ)"
                            ><input
                                type="checkbox"
                                id="output_terrain"
                                name="output_terrain"
                                {%
                                if
                                defaults.output_terrain
                                %}checked{%
                                endif
                                %}
                            />
                            Terrain Mesh</label
                        >
                        <label class="check" title="buildings.obj (OBJ)"
                            ><input
                                type="checkbox"
                                id="output_buildings"
                                name="output_buildings"
                                {%
                                if
                                defaults.output_buildings
                                %}checked{%
                                endif
                                %}
                            />
                            Building Massing</label
                        >
                    </div>

                    <div class="section-title" style="margin-top: 18px">
                        Settings
                    </div>
                    <div id="advancedControls" class="advanced-controls">
                        <div id="meshResolutionSection">
                            <label>Output Resolution</label>
                            <div class="slider-row">
                                <input
                                    type="range"
                                    min="0"
                                    max="10"
                                    step="1"
                                    name="terrain_complexity"
                                    value="{{ defaults.terrain_complexity }}"
                                    oninput="
                                        document.getElementById(
                                            'complexityValue',
                                        ).textContent = this.value
                                    "
                                />
                                <div id="complexityValue">
                                    {{ defaults.terrain_complexity }}
                                </div>
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="rotationSection">
                                <label
                                    title="Degrees from true north (+Y). Positive is counter-clockwise, negative is clockwise. Rotates meshes and DXF/XYZ around the --center point. terrain.png stays north-up on disk, while texture mapping remains aligned to the rotated terrain mesh."
                                    >Project North (Deg)</label
                                >
                                <input
                                    type="number"
                                    step="any"
                                    name="rotate_z"
                                    value="{{ defaults.rotate_z }}"
                                />
                            </div>
                        </div>

                        <div id="contourSmoothingSection">
                            <label>Contour Smoothing</label>
                            <div class="slider-row">
                                <input
                                    type="range"
                                    id="dxfSpacingRange"
                                    name="dxf_contour_spacing"
                                    min="0"
                                    max="10"
                                    step="1"
                                    value="{{ defaults.dxf_contour_spacing }}"
                                    oninput="
                                        document.getElementById(
                                            'dxfSpacingValue',
                                        ).textContent = this.value
                                    "
                                />
                                <div id="dxfSpacingValue">
                                    {{ defaults.dxf_contour_spacing }}
                                </div>
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="contourIntervalSection">
                                <label
                                    >Contour Interval (<span data-unit-label
                                        >feet</span
                                    >)</label
                                >
                                <div
                                    class="segmented"
                                    data-target="contour_interval"
                                >
                                    <button type="button" data-value="1">
                                        1
                                    </button>
                                    <button type="button" data-value="2">
                                        2
                                    </button>
                                    <button type="button" data-value="5">
                                        5
                                    </button>
                                    <button type="button" data-value="10">
                                        10
                                    </button>
                                </div>
                                <input
                                    type="hidden"
                                    id="contour_interval"
                                    name="contour_interval"
                                    value="{{ defaults.contour_interval }}"
                                />
                            </div>
                            <div id="contourLayersSection">
                                <label>Layers</label>
                                <div class="segmented contour-icons" data-toggle-group="layers">
                                    <button
                                        type="button"
                                        class="active static"
                                        title="Contours"
                                        aria-label="Contours"
                                        disabled
                                    >
                                        <i data-lucide="waves"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_parcels"
                                        title="Parcels"
                                        aria-label="Parcels"
                                    >
                                        <i data-lucide="layout-grid"></i>
                                    </button>
                                    <button
                                        type="button"
                                        data-input="dxf_include_buildings"
                                        title="Building Footprints"
                                        aria-label="Building Footprints"
                                    >
                                        <i data-lucide="house"></i>
                                    </button>
                                </div>
                                <input
                                    type="checkbox"
                                    id="dxf_include_parcels"
                                    name="dxf_include_parcels"
                                    class="visually-hidden"
                                    {%
                                    if
                                    defaults.dxf_include_parcels
                                    %}checked{%
                                    endif
                                    %}
                                />
                                <input
                                    type="checkbox"
                                    id="dxf_include_buildings"
                                    name="dxf_include_buildings"
                                    class="visually-hidden"
                                    {%
                                    if
                                    defaults.dxf_include_buildings
                                    %}checked{%
                                    endif
                                    %}
                                />
                            </div>
                        </div>

                        <div class="grid two-col">
                            <div id="xyzSamplingSection">
                                <label>Point Cloud Mode</label>
                                <select id="xyz_mode" name="xyz_mode">
                                    <option value="contours" {% if defaults.xyz_mode is equalto 'contours' %}selected{% endif %}>Contours</option>
                                    <option value="grid" {% if defaults.xyz_mode is equalto 'grid' %}selected{% endif %}>Uniform Grid</option>
                                </select>
                            </div>
                            <div id="imageQualitySection">
                                <label>Satellite Image Quality</label>
                                <div
                                    class="segmented"
                                    data-target="image_quality"
                                >
                                    <button type="button" data-value="standard">
                                        S
                                    </button>
                                    <button type="button" data-value="high">
                                        M
                                    </button>
                                    <button type="button" data-value="ultra">
                                        L
                                    </button>
                                </div>
                                <input
                                    type="hidden"
                                    id="image_quality"
                                    name="image_quality"
                                    value="{{ defaults.image_quality }}"
                                />
                            </div>
                        </div>
                        <div id="buildingHeightsSection" class="grid two-col">
                            <div>
                                <label>Min Building Height</label>
                                <input
                                    type="number"
                                    step="any"
                                    name="random_min_height"
                                    value="{{ defaults.random_min_height }}"
                                />
                            </div>
                            <div>
                                <label>Max Building Height</label>
                                <input
                                    type="number"
                                    step="any"
                                    name="random_max_height"
                                    value="{{ defaults.random_max_height }}"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <div id="parcelAlert" class="status hidden"></div>
                    <div class="form-actions">
                        {% if can_build %}
                        <button class="btn" id="runBtn" type="submit">
                            Build
                        </button>
                        {% elif auth_enabled %}
                        <a class="btn" id="loginBtn" href="{{ url_for('bp.auth_login', next='/') }}">
                            Login to Build
                        </a>
                        {% endif %}
                        <button class="btn secondary" type="reset">
                            Reset
                        </button>
                    </div>
                </div>
            </form>
            <div class="card">
                <div class="section-title">Recent Jobs</div>
                <div id="recentJobs">
                    {% if not can_build %}
                    <p class="footer">Sign in to view your jobs and downloads.</p>
                    {% elif recent_jobs %}
                    <ul class="recent-job-list">
                        {% for job in recent_jobs %}
                        <li class="recent-job-row">
                            <div class="recent-job-title">{{ job.display_title }}</div>
                            {% if job.status == 'done' %}
                            <div class="recent-job-actions">
                                {% if job.preview_url %}
                                <a
                                    class="recent-job-pill"
                                    href="{{ job.preview_url }}"
                                    data-preview-modal="1"
                                    data-preview-url="{{ job.preview_url }}"
                                    data-preview-title="{{ job.name }}"
                                >Preview</a>
                                {% endif %}
                                {% if job.download_all_url %}
                                <a class="recent-job-pill" href="{{ job.download_all_url }}">Download</a>
                                {% endif %}
                                {% if job.match_settings_url %}
                                <a class="recent-job-pill" href="{{ job.match_settings_url }}">Match Settings</a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="footer">No jobs yet.</p>
                    {% endif %}
                </div>
            </div>
            <div class="note data-sources">
                <span class="data-sources-label">Data sources:</span>
                <div class="data-source-group">
                    {% for source in data_sources %}
                    <a
                        class="data-pill"
                        href="{{ source.url }}"
                        target="_blank"
                        rel="noopener"
                        title="{{ source.details | join(', ') }}"
                        >{{ source.name }}</a
                    >
                    {% endfor %}
                </div>
            </div>
        </main>
        <div id="previewModal" class="preview-modal hidden" aria-hidden="true">
            <div class="preview-modal-backdrop" data-preview-close="1"></div>
            <div class="preview-modal-dialog" role="dialog" aria-modal="true" aria-label="Job Preview">
                <iframe id="previewModalFrame" class="preview-modal-frame" title="Job Preview"></iframe>
            </div>
        </div>
        <i
            id="faviconSource"
            class="visually-hidden"
            data-lucide="mountain"
            aria-hidden="true"
        ></i>
        <script src="https://unpkg.com/lucide@0.575.0/dist/umd/lucide.min.js"
                integrity="sha384-GzE8qT1LzDfRNjtvLN/dXDLPlJOB3BBom3Twb9/RwHkXCgNl6OU1pBxM9397HWGU"
                crossorigin="anonymous"></script>
        <script>
          window.APP_CONFIG = {
            parcelSources: {{ parcel_sources | tojson }},
            canBuild: {{ can_build | tojson }},
          };
        </script>
        <script src="{{ url_for('static', filename='app.js') }}" defer></script>
    </body>
</html>
