services:
  caddy:
    image: caddy:2
    environment:
      APP_DOMAIN: ${APP_DOMAIN:?APP_DOMAIN must be set in .env}
      ACME_EMAIL: ${ACME_EMAIL:?ACME_EMAIL must be set in .env}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - terrain-ui-blue
    restart: unless-stopped

  terrain-ui-blue:
    build: .
    image: ${APP_IMAGE:-va-lidar-context:latest}
    environment:
      VA_OUT_DIR: /data/out
      VA_DB_PATH: /data/app/app.db
      VA_RETENTION_DAYS: "7"
      VA_CLEANUP_INTERVAL: "3600"
      VA_AUTH_PROVIDER: ${VA_AUTH_PROVIDER:-}
      VA_CLERK_PUBLISHABLE_KEY: ${VA_CLERK_PUBLISHABLE_KEY:-}
      VA_CLERK_SECRET_KEY: ${VA_CLERK_SECRET_KEY:-}
      VA_CLERK_FRONTEND_API_URL: ${VA_CLERK_FRONTEND_API_URL:-}
      VA_CLERK_SIGN_IN_URL: ${VA_CLERK_SIGN_IN_URL:-}
      VA_CLERK_JWKS_URL: ${VA_CLERK_JWKS_URL:-}
      VA_CLERK_ISSUER: ${VA_CLERK_ISSUER:-}
      VA_CLERK_API_URL: ${VA_CLERK_API_URL:-https://api.clerk.com/v1}
      VA_CLERK_ALLOWED_DOMAIN: ${VA_CLERK_ALLOWED_DOMAIN:-}
      VA_CLERK_AUTHORIZED_PARTIES: ${VA_CLERK_AUTHORIZED_PARTIES:-}
      VA_SESSION_SECRET: ${VA_SESSION_SECRET:?VA_SESSION_SECRET must be set in .env}
      VA_ADMIN_EMAIL: ${VA_ADMIN_EMAIL:-}
      VA_RATE_LIMIT_HOURLY: ${VA_RATE_LIMIT_HOURLY:-3}
      VA_RATE_LIMIT_DAILY: ${VA_RATE_LIMIT_DAILY:-10}
      VA_MAX_ACTIVE_JOBS_PER_USER: ${VA_MAX_ACTIVE_JOBS_PER_USER:-1}
      VA_MAX_CLIP_SIZE: ${VA_MAX_CLIP_SIZE:-5000}
    volumes:
      - /data/out:/data/out
      - /data/app:/data/app
    restart: unless-stopped

  terrain-ui-green:
    build: .
    image: ${APP_IMAGE:-va-lidar-context:latest}
    profiles: ["green"]
    environment:
      VA_OUT_DIR: /data/out
      VA_DB_PATH: /data/app/app.db
      VA_RETENTION_DAYS: "7"
      VA_CLEANUP_INTERVAL: "3600"
      VA_AUTH_PROVIDER: ${VA_AUTH_PROVIDER:-}
      VA_CLERK_PUBLISHABLE_KEY: ${VA_CLERK_PUBLISHABLE_KEY:-}
      VA_CLERK_SECRET_KEY: ${VA_CLERK_SECRET_KEY:-}
      VA_CLERK_FRONTEND_API_URL: ${VA_CLERK_FRONTEND_API_URL:-}
      VA_CLERK_SIGN_IN_URL: ${VA_CLERK_SIGN_IN_URL:-}
      VA_CLERK_JWKS_URL: ${VA_CLERK_JWKS_URL:-}
      VA_CLERK_ISSUER: ${VA_CLERK_ISSUER:-}
      VA_CLERK_API_URL: ${VA_CLERK_API_URL:-https://api.clerk.com/v1}
      VA_CLERK_ALLOWED_DOMAIN: ${VA_CLERK_ALLOWED_DOMAIN:-}
      VA_CLERK_AUTHORIZED_PARTIES: ${VA_CLERK_AUTHORIZED_PARTIES:-}
      VA_SESSION_SECRET: ${VA_SESSION_SECRET:?VA_SESSION_SECRET must be set in .env}
      VA_ADMIN_EMAIL: ${VA_ADMIN_EMAIL:-}
      VA_RATE_LIMIT_HOURLY: ${VA_RATE_LIMIT_HOURLY:-3}
      VA_RATE_LIMIT_DAILY: ${VA_RATE_LIMIT_DAILY:-10}
      VA_MAX_ACTIVE_JOBS_PER_USER: ${VA_MAX_ACTIVE_JOBS_PER_USER:-1}
      VA_MAX_CLIP_SIZE: ${VA_MAX_CLIP_SIZE:-5000}
    volumes:
      - /data/out:/data/out
      - /data/app:/data/app
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
